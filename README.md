istanbul-cobertura-badger
=========================
[![Travis](https://travis-ci.org/marcellodesales/istanbul-cobertura-badger.svg)](https://travis-ci.org/marcellodesales/istanbul-cobertura-badger) [![npm version](https://badge.fury.io/js/istanbul-cobertura-badger.svg)](http://badge.fury.io/js/istanbul-cobertura-badger) [![Codacy Badge](https://www.codacy.com/project/badge/29edfafa9850429c9a4ac0be2742956b)](https://www.codacy.com/app/marcello-desales/istanbul-cobertura-badger) [![Dependency Status](https://gemnasium.com/marcellodesales/istanbul-cobertura-badger.svg)](https://gemnasium.com/marcellodesales/istanbul-cobertura-badger) [![Coverage Status](https://coveralls.io/repos/marcellodesales/istanbul-cobertura-badger/badge.svg?branch=develop&service=github)](https://coveralls.io/github/marcellodesales/istanbul-cobertura-badger?branch=develop) ![License](https://img.shields.io/badge/license-MIT-lightgray.svg)

Creates a coverage badge by reading the Cobertura XML coverage report from node-istanbul reports using  https://github.com/badges/shields.

[![NPM](https://nodei.co/npm/istanbul-cobertura-badger.png?downloads=true&downloadRank=true&stars=true)](https://nodei.co/npm/istanbul-cobertura-badger/)

Requirements
========

I started to work with Node a few months ago, and I recently stumble upon many different badges on GitHub pages,
including code coverage. I posted a question on Stackoverflow about it:

http://stackoverflow.com/questions/26028024/how-to-make-a-gulp-code-coverage-badge

* I want to be able to generate the coverage report after code coverage runs by any Node.js build system like
Gulp or Grunt, and be able to publish the badge on the README.md file through a Jenkins link;
* The badge displays appropriate colors for the badge.
 * Green: >= 80% overall coverage ![](http://img.shields.io/badge/coverage-93%-brightgreen.svg)
 * Yellow: 65% <= overall coverage < 80% ![](http://img.shields.io/badge/coverage-74%-yellow.svg)
 * Red: < 65% overall coverage ![](http://img.shields.io/badge/coverage-32%-red.svg)

The idea is to serve in the Node.js README for internal use in a GitHub enterprise machine along with
Jenkins.

Installation
=========

```
npm install --save-dev istanbul-cobertura-badger
```
Setup
=========

The following parameters are used:

* Cobertura file report: The XML-based cobertura file generated by Istanbul "cobertura" report.
* Destination Path: The path to the destination directory where the badge image will be created.
* Callback: The callback function after the file has been downloaded.
* Optional Thresholds: Adjust the thresholds if needed.

Cobertura Xml Report
--------

You can generate the cobertura XML report by adding a new report to the istanbul command as follows:

```
  --report cobertura
```

Take a look at this project's `package.json` for details.

The option to change in the code is as follows:

```js
  // Setting the default coverage file generated by istanbul cobertura report.
  opts.istanbulReportFile = opts.istanbulReportFile || "./coverage/cobertura-coverage.xml";
```

Destination Dir
-----

The destination directory will, by default, be the one from istanbul `$APP/coverage`.

```js
  // The default location for the destination being the coverage directory from istanbul.
  opts.destinationDir = opts.destinationDir || "./coverage/";
```

Note that the default directory will be used as `coverage/cobertura-coverage.xml`.

Adjusting Thresholds
---------

The overall threshold is computed by using the `line rate`, `branch rate` and `function rate`. That's the final value that defines 
`coverage result`. You can adjust the thresholds to properly generate the badges with appropriate colors.

```js
  // The thresholds to be used to give colors to the badge.
  opts.thresholds = {
    excelent: 90,
    good: 65
  };
```

* *Green*: coverage result >= opts.thresholds.excelent;
* *Yellow*: coverage result >= opts.thresholds.good;
* *Red*: coverage result < opts.thresholds.good.

Upon calling the callback function, the file `cobertura.svg` will be available in the destination path.

Examples
========

```
var coberturaBadger = require('istanbul-cobertura-badger');

// Use the fixture that's without problems
var opts = {
  destinationDir: __dirname,
  istanbulReportFile: path.resolve(__dirname, "coverage", "cobertura-coverage.xml"),
  thresholds: {
    // overall percent >= excelent, green badge
    excelent: 90,
    // overall percent < excelent and >= good, yellow badge
    good: 65
    // overall percent < good, red badge
  }
};

// Load the badge for the report$
badger(opts, function parsingResults(err, badgeStatus) {
  if (err) {
    console.log("An error occurred: " + err.message);
  }
  console.log("Badge successfully generated at " + badgeStatus.badgeFile.file);
  console.log(badgeStatus);
});
```

An example of a successful badge creation is as follows:

```js
{ overallPercent: 66,
  functionRate: 0.7368421052631579,
  lineRate: 0.8034,
  branchRate: 0.47369999999999995,
  url: 'http://img.shields.io/badge/coverage-66%-yellow.svg',
  badgeFile: { 
    method: 'GET',
    code: 200,
    file: '/home/mdesales/dev/github/intuit/istanbul-cobertura-badger/test/coverage.svg' 
  }
}
```

Gulp Build
=========

```
gulp.task('test', function() {
  gulp.src('src/**/*.js')
    .pipe(istanbul()) // coverying files
    .on('finish', function () {
      gulp.src(['test/*.js'])
        .pipe(mocha({reporter: 'spec'})) // different reporters at http://visionmedia.github.io/mocha/#reporters
        .pipe(istanbul.writeReports({
          reporters: ['cobertura', 'text-summary', 'html'], // https://www.npmjs.org/package/gulp-istanbul#reporters
          reportOpts: { dir: './docs/tests' }
        }))
        .on('end', function() {

          var opts = {
            destinationDir: path.resolve(__dirname, "docs", "tests"),
            istanbulReportFile: path.resolve(__dirname, "docs", "tests", "cobertura-coverage.xml"),
          }
          coverageBadger(opts, function(err, results) {
            if (err) {
              console.log("An error occurred while generating the coverage badge" + err.message);
              process.exit(-1);
            }
            console.log("Badge generated successfully: " + results)
            process.exit(0);
           });

        });
    });
});
```

CLI
===

```
$ istanbul report cobertura
$ mkdir -p out
$ istanbul-cobertura-badger coverage/cobertura-coverage.xml out
Badge created at /my/project/out/coverage.svg
```

Contributing
==============

We use the GitFlow branching model http://nvie.com/posts/a-successful-git-branching-model/.

1. Fork it
2. Create your feature branch (`git checkout -b feature/issue-444-Add-Rest-APIs origin/master --track`)
 * Adding the Jira ticket ID helps communicating where this feature is coming from.
3. Commit your changes (`git commit -am 'Fix #444: Add support to REST-APIs'`)
 * Adding "fix #444" will trigger a link to the GitHub issue #444.
4. Push to the branch (`git push feature/issue-444-Add-Rest-APIS`)
5. Create new Pull Request as indicated by this page or your forked repo.
